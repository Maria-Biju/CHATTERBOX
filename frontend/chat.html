<!DOCTYPE html>
<html>
<head>
  <title>Chat | ChatterBox</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="chat-body">

<div class="chat-shell">
  <div class="chat-header">
    <div class="chat-header-left">
      <div class="chat-title">ChatterBox üí¨</div>
      <div class="chat-subtitle" id="onlineUsersHeader">Connected</div>
    </div>
    <div class="chat-header-right">
      <span id="currentUser"></span>
    </div>
  </div>

  <div class="chat-main">
    <aside class="chat-sidebar">
      <div class="sidebar-title">Online users</div>
      <ul id="onlineUsersList" class="sidebar-list">
        <li>Loading...</li>
      </ul>
    </aside>

    <section class="chat-content">
      <div id="chatBox" class="chat-box"></div>
      <div id="error" class="chat-error"></div>
      <div class="chat-input-bar">
        <input id="message" class="chat-input" placeholder="Type a message..." />
        <button id="sendBtn" class="chat-send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </section>
  </div>
</div>

<script>
const username = localStorage.getItem("username");
const token = localStorage.getItem("token");

if (!username || !token) {
  window.location.href = "/ui/login.html";
}

document.getElementById("currentUser").innerText = `Logged in as ${username}`;

const ws = new WebSocket("ws://127.0.0.1:8000/ws?token=" + token);

function renderMessage(data) {
  const chatBox = document.getElementById("chatBox");
  const existing = document.querySelector(`[data-msg-id="${data.id}"]`);
  const isSelf = data.user === username;
  const tick = isSelf ? (data.seen ? "‚úÖ" : "‚úîÔ∏è") : "";
  const msgSideClass = isSelf ? "msg-self" : "msg-other";

  const wrapper = existing || document.createElement("div");
  wrapper.className = `msg ${msgSideClass}`;
  wrapper.dataset.msgId = data.id;

  const actions = isSelf
    ? `<span class="user-actions">
         <span class="user-action-icon" onclick="editMessage(${data.id}, '${encodeURIComponent(data.text)}')">‚úèÔ∏è</span>
         <span class="user-action-icon" onclick="deleteMessage(${data.id})">üóëÔ∏è</span>
       </span>`
    : "";

  wrapper.innerHTML = `
    <div class="user">
      <span class="user-name">${data.user}</span>
      ${actions}
    </div>
    <div class="msg-text">${data.text}</div>
    <div class="time">${data.time} ${tick}</div>
  `;

  if (!existing) {
    // new message: add enter animation class
    wrapper.classList.add("msg-enter");
    chatBox.appendChild(wrapper);
    setTimeout(() => wrapper.classList.remove("msg-enter"), 220);
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  const errorP = document.getElementById("error");

  if (data.type === "message") {
    errorP.innerText = "";
    renderMessage(data);

  } else if (data.type === "error") {
    errorP.innerText = data.message;

  } else if (data.type === "users") {
    const ul = document.getElementById("onlineUsersList");
    ul.innerHTML = "";
    const users = data.users || [];
    const headerEl = document.getElementById("onlineUsersHeader");

    if (!users.length) {
      ul.innerHTML = "<li>None</li>";
      headerEl.innerText = "No one online";
      return;
    }

    const formatted = users.map(u => u === username ? `${u} (you)` : u);
    headerEl.innerText = `Online (${users.length})`;

    users.forEach(u => {
      const li = document.createElement("li");
      li.textContent = u === username ? `${u} (you)` : u;
      ul.appendChild(li);
    });

  } else if (data.type === "delete") {
    const el = document.querySelector(`[data-msg-id="${data.id}"]`);
    if (el && el.parentNode) {
      el.parentNode.removeChild(el);
    }

  } else if (data.type === "edit") {
    const el = document.querySelector(`[data-msg-id="${data.id}"]`);
    if (el) {
      const textDiv = el.querySelector(".msg-text");
      if (textDiv) {
        textDiv.textContent = data.text;
      }
      // pulse animation on edit
      el.classList.add("msg-edited");
      setTimeout(() => el.classList.remove("msg-edited"), 400);
    }
  }
};

function sendMessage() {
  const input = document.getElementById("message");
  const msg = input.value.trim();
  if (!msg) return;

  ws.send(JSON.stringify({
    type: "send",
    text: msg
  }));

  input.value = "";
}

function deleteMessage(id) {
  ws.send(JSON.stringify({
    type: "delete",
    id: id
  }));
}

function editMessage(id, encodedOldText) {
  const oldText = decodeURIComponent(encodedOldText);
  const newText = prompt("Edit your message:", oldText);
  if (newText === null) return;
  const trimmed = newText.trim();
  if (!trimmed) return;

  ws.send(JSON.stringify({
    type: "edit",
    id: id,
    text: trimmed
  }));
}
</script>
</body>
</html>
